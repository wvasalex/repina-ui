<div
  *ngFor="let block of $visible(blocks); let index = index; let first = first; let last = last;"
  [attr.rel]="typeKey + '_' + index"
  [attr.class]="typeKey + ' content-item'"
>
  <div
    *ngIf="editor && $hasControls(block)"
    class="move-block move-up controls"
  >
    <r-icon
      *ngIf="!first"
      (click)="$move(block, -1)"
      name="components/down-arrow"
      matTooltip="Переместить вверх"
      class="icon revert"
    ></r-icon>

    <r-icon
      (click)="availableBlocks ? null : $addBlock(block, 0)"
      (onMenuOpen)="$checkMenu(blockSelector)"
      [matMenuTriggerFor]="blockSelector"
      [matMenuTriggerData]="{block: block, offset: 0}"
      name="components/add"
      matTooltip="Добавить блок выше"
      class="icon revert"
    ></r-icon>
  </div>

  <r-block-switcher
    *ngIf="editor && typeKey == 'element_type' && availableElements?.length"
    (change)="$setType(block, $event)"
    [availableElements]="availableElements"
  >
    {{block.element_type}}
  </r-block-switcher>

  <ndc-dynamic
    [ndcDynamicComponent]="$component(block)"
    [ndcDynamicInputs]="{
      id: block.id,
      props: block.props,
      contentFile: block.content_file,
      elements: block.content_elements,
      availableElements: availableElements,
      editor: editor,
      render: render,
      index: index
    }"
  ></ndc-dynamic>

  <div
    *ngIf="editor && $hasControls(block)"
    class="move-block move-down controls"
  >
    <r-icon
      *ngIf="!last"
      (click)="$move(block, 1)"
      name="components/down-arrow"
      matTooltip="Переместить вниз"
      class="icon"
    ></r-icon>

    <r-icon
      (click)="availableBlocks ? null : $addBlock(block, 1)"
      (onMenuOpen)="$checkMenu(blockSelector)"
      [matMenuTriggerFor]="blockSelector"
      [matMenuTriggerData]="{block: block, offset: 1}"
      name="components/add"
      matTooltip="Добавить блок ниже"
      class="icon"
    ></r-icon>
  </div>

  <div
    *ngIf="editor && $hasControls(block)"
    class="main-controls row"
  >
    <ng-container *ngTemplateOutlet="controlTmp; context: {block: block}"></ng-container>

    <mat-checkbox
      [(ngModel)]="block.is_enabled"
      matTooltip="Использовать"
    ></mat-checkbox>

    <r-icon-button
      (click)="$swapElements(block)"
      [size]="18"
      matTooltip="Поменять элементы местами"
      icon="repeat"
      class="ml-2"
    ></r-icon-button>

    <r-icon-button
      (click)="$remove(block)"
      [size]="18"
      matTooltip="Удалить"
      icon="close"
      class="ml-2"
    ></r-icon-button>
  </div>

  <mat-menu
    #blockSelector="matMenu"
  >
    <ng-template
      matMenuContent
      let-block="block"
      let-offset="offset"
    >
      <button
        *ngFor="let blockDescriptor of availableBlocks"
        (click)="$addBlock(block, offset, blockDescriptor.value)"
        mat-menu-item
      >
        {{blockDescriptor.label}}
      </button>
    </ng-template>
  </mat-menu>
</div>
